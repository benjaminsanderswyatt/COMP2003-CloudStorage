@page
@using Ethereal_Cloud.Models
@model Ethereal_Cloud.Pages.UploadModel
@{
    ViewBag.Title = "Upload";
    Layout = "Shared/_Layout.cshtml";
    <link rel="stylesheet" href="/css/Upload.css" asp-append-version="true">
}

<!-- File explorer -->
<div id="file-explorer" class="row mt-3">

    <!-- Files Toolbox -->
    <div id="toolbox" class="col-lg-1 col-md-2 col-sm-2">
        <div id="tools" class="row">

            <!-- Sort button -->
            <div id="tool-row" onclick="toggleImage()">
                <a id="tool-label">
                    <img id="toggleImage" class="row" src="~/images/tools/sort-alpha-down.svg" alt="Image 1">
                </a>
                <p class="row">Sort</p>
            </div>

            <!-- New folder button -->
            <div id="tool-row">
                <a id="tool-label" href="#" onclick="showInputBox()">
                    <img class="row" src="~/images/tools/folder-plus.svg" alt="new-folder">
                </a>
                <p class="row">New</p>
            </div>

            <!-- Share button -->
            <div id="tool-row">
                <a id="tool-label">
                    <img class="row" src="~/images/tools/share.svg" alt="share">
                </a>
                <p class="row">Share</p>
            </div>

            <!-- Delete button -->
            <div id="tool-row">
                <a id="tool-label">
                    <img class="row" src="~/images/tools/trash.svg" alt="trash">
                </a>
                <p class="row">Delete</p>
            </div>
        </div>
    </div>

    <!-- Files Box -->
    <div id="filebox" class="col-lg-11 col-md-10 col-sm-10 h-100">
        <!-- FilePath -->
        <div id="filepath" class="row">
            <!-- Path Back button-->
            <div id="filepath-button" class="col">
                <a asp-page-handler="GoToFolderInPath" asp-route-Id="-1">
                    <img src="~/images/file-path/path-back.svg" alt="path">
                </a>
            </div>
            <!-- Root Image -->
            <div class="col" id="path-root">
                <a asp-page-handler="GoToFolderInPath" asp-route-Id="-2">
                    <img src="~/images/file-path/path-root.svg" alt="path">
                </a>
            </div>

            <div id="content-container" class="col">
                <!-- Current Filepath-->
                @if (Model.FolderPath.Count > 0)
                {
                    @foreach (var display in Model.FolderPath)
                    {
                        <div id="path-divider" class="col">></div>

                        <div class="file-hover">
                            <a asp-page-handler="GoToFolderInPath" asp-route-Id="@display.FolderID">
                                <p id="path-folder" style="margin:0px;">@display.Foldername</p>
                            </a>
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Appears when the files are loaded -->
        <div id="scrollbox" class="row">

            <!-- Hidden folder naming input box -->
            <div id="input-box" class="popup-input" style="display:none;">
                <form id="folder-form" method="post" asp-page-handler="CreateFolder">
                    <!--FileName Field-->
                    <div class="form-floating">
                        <input asp-for="createFolderDetails.FolderName" class="form-control" placeholder=" ">
                        <label for="folderName">Folder Name</label>
                        <span asp-validation-for="createFolderDetails.FolderName" class="text-danger"></span>
                    </div>

                    <!-- Submit button -->
                    <div class="mb-3 ">
                        <button type="submit" id="create-folder-btn" class="popup-input-btn btn btn-primary">Create Folder</button>
                        <!-- Add: onclick="enableScroll()" to above to disable scrolling when input is open -->
                    </div>
                </form>
            </div>

            <!-- Success/error messages -->
            <div class="popup-message">
                @if (ViewData["FailureMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show mx-auto">
                        <strong>Error!</strong> @ViewData["FailureMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }
            </div>

            @if (Model.DisplayList.Count > 0)
            {
                @foreach (var display in Model.DisplayList)
                {
                    <div id="uploaded-files" class="file-hover">
                        <a asp-page-handler="@GetFileItemHandler(display.Type)" asp-route-id="@display.Id" asp-route-name="@display.Name">
                            <img src="~/images/file-icons/@GetImageForFileType(@display.Type)" alt="logo" class="logo">
                        </a>
                        <p>@display.Name</p>
                    </div>
                }
            }
            else
            {
                <div class="no-files">
                    <img class="row" src="~/images/tools/search.svg" alt="search" style="width: -webkit-fill-available; opacity: 50%;">
                    <h3 class="row">No files here</h3>
                </div>
            }
        </div>
    </div>
</div>

<!-- Bottom upload dotted box -->
<div id="upload-box" class="row mt-3">
    <h3>Upload your files</h3>
    <form method="post" enctype="multipart/form-data" asp-page-handler="Upload">
        <div class="mb-3" id="file-input-box">
            <input class="form-control" type="file" name="uploadedFile" id="fileInput" multiple>
            <input type="submit" class="btn btn-success" value="Upload" />
        </div>
    </form>
</div>

@{
    <!-- Scripts -->
    <script>
        // Console logger
        var logger = '@ViewData["logger"]';
        if (logger !== null) {
            console.log(decodeHtml(logger));
        }

        //Decodes html text
        function decodeHtml(html) {
            var txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        }

        //Changes the sort image when pressed
        function toggleImage() {
            var imageElement = document.getElementById('toggleImage');
            if (imageElement.src.endsWith('sort-alpha-down.svg')) {
                imageElement.src = 'images/tools/sort-alpha-up.svg';
            } else {
                imageElement.src = 'images/tools/sort-alpha-down.svg';
            }
        }

        //Loads naming foler popup
        function showInputBox() {
            // Show the input box
            document.getElementById('input-box').style.display = 'block';
            //document.body.classList.add('popup-open'); // This disable scrolling in the background

            // Set focus on the input field
            document.querySelector('#input-box input[name="foldername"]').focus();
        }

        /*
        //Re enable background scrolling
        function enableScroll() {
            // Show the input box
            document.body.classList.remove('popup-open'); // This enables scrolling in the background
        }
        */
    </script>

    string GetFileItemHandler(string fileHandler)
    {
        if (fileHandler == "Folder")
        {
            return "Navigate";
        }
        else
        {
            return "Download";
        }
    }

    string GetImageForFileType(string fileType)
    {
        //looks at files Mime type and gets appropriate image
        switch (fileType.ToLower())
        {
            case "folder":
                return "folder.svg";
            case "image/png":
            case "image/jpeg":
            case "image/gif":
                return "file-image.svg";
            case "audio/mpeg":
                return "file-music.svg";
            case "video/mp4":
                return "file-video.svg";
            case "application/pdf":
                return "file-pdf.svg";
            case "application/msword":
            case "text/plain":
                return "file-doc.svg";
            default:
                return "unknown.svg"; //Unknown type
        }
    }
}